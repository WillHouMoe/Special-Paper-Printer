<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>笔记纸打印软件 (最终修复版)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#3b82f6', secondary: '#64748b' },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-gray-100 font-sans h-screen flex flex-col overflow-hidden">

    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex items-center justify-center transition-opacity duration-300">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
            <p class="mt-4 text-lg text-gray-600">正在初始化引擎...</p>
        </div>
    </div>

    <div id="welcome-screen" class="fixed inset-0 bg-white z-40 flex items-center justify-center p-4 overflow-y-auto">
        <div class="max-w-md w-full bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">笔记纸打印软件</h1>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">纸张宽度</label>
                    <div class="flex">
                        <input id="paper-width" type="number" min="1" max="100" value="18.2" class="w-2/3 px-3 py-2 border border-gray-300 rounded-l-md focus:ring-2 focus:ring-primary outline-none">
                        <select id="width-unit" class="w-1/3 px-3 py-2 border border-gray-300 rounded-r-md outline-none bg-gray-50">
                            <option value="cm">厘米</option>
                            <option value="mm">毫米</option>
                            <option value="in">英寸</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">纸张高度</label>
                    <div class="flex">
                        <input id="paper-height" type="number" min="1" max="100" value="25.7" class="w-2/3 px-3 py-2 border border-gray-300 rounded-l-md focus:ring-2 focus:ring-primary outline-none">
                        <select id="height-unit" class="w-1/3 px-3 py-2 border border-gray-300 rounded-r-md outline-none bg-gray-50">
                            <option value="cm">厘米</option>
                            <option value="mm">毫米</option>
                            <option value="in">英寸</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">上传背景模板</label>
                    <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <i class="fa fa-cloud-upload text-3xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-500">点击上传或拖放文件</p>
                            <p class="text-xs text-gray-400 mt-1" id="file-status">未选择文件</p>
                        </div>
                        <input id="template-upload" type="file" class="hidden" accept="image/*" />
                    </label>
                </div>
                <div class="text-center mt-6">
                    <button id="start-editing" class="bg-primary hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-md disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>
                        开始编辑
                    </button>
                </div>
                <div class="text-center mt-2">
                    <button id="use-template" class="text-primary hover:text-blue-600 text-sm font-medium">使用示例模板</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app" class="hidden h-full flex flex-col">
        <header class="bg-white shadow-sm z-10 shrink-0">
            <div class="container mx-auto px-6 py-3 flex items-center justify-between">
                <div class="flex items-center gap-6">
                    <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i class="fa fa-pencil-square-o text-primary"></i> 编辑器
                    </h1>
                    <div class="hidden md:flex items-center gap-3">
                        <button id="btn-clear" class="btn-tool" title="清空画布"><i class="fa fa-trash-o"></i> 清空</button>
                        <button id="btn-save" class="btn-tool" title="保存为工程文件"><i class="fa fa-save"></i> 保存</button>
                        <button id="btn-export" class="btn-tool" title="导出图片"><i class="fa fa-download"></i> 导出</button>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-xs text-gray-400 hidden lg:block mr-2">
                        <i class="fa fa-keyboard-o"></i> Ctrl+滚轮缩放 / Ctrl+P 打印
                    </div>
                    <button id="btn-print" class="bg-primary hover:bg-blue-600 text-white px-6 py-2 rounded-md text-sm font-medium transition-colors shadow-sm flex items-center gap-2">
                        <i class="fa fa-print"></i> 打印内容
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 flex overflow-hidden">
            <div class="w-64 bg-white shadow-md flex flex-col overflow-y-auto shrink-0 z-10 border-r border-gray-200">
                <div class="p-4 border-b">
                    <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">添加内容</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="add-text-btn" class="p-3 border rounded-lg hover:bg-blue-50 hover:border-blue-200 transition-all flex flex-col items-center justify-center text-gray-700 group">
                            <i class="fa fa-font text-2xl mb-2 text-gray-400 group-hover:text-primary"></i>
                            <span class="text-xs font-medium">文本</span>
                        </button>
                        <label class="p-3 border rounded-lg hover:bg-blue-50 hover:border-blue-200 transition-all flex flex-col items-center justify-center text-gray-700 cursor-pointer group">
                            <i class="fa fa-picture-o text-2xl mb-2 text-gray-400 group-hover:text-primary"></i>
                            <span class="text-xs font-medium">图片</span>
                            <input type="file" id="add-image-input" class="hidden" accept="image/*">
                        </label>
                    </div>
                </div>

                <div id="object-properties" class="p-4 border-b flex-1 hidden">
                    <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">属性设置</h2>
                    <div id="text-controls" class="space-y-4 hidden">
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">颜色</label>
                            <div class="flex items-center border rounded p-1">
                                <input type="color" id="prop-color" class="w-8 h-8 cursor-pointer rounded border-none p-0 mr-2">
                                <span class="text-xs text-gray-500" id="color-val-text">#000000</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">字号</label>
                            <input type="range" id="prop-fontsize" min="10" max="100" class="w-full accent-primary">
                        </div>
                        <div class="flex gap-2">
                            <button id="prop-bold" class="flex-1 py-1.5 border rounded hover:bg-gray-100 transition-colors"><i class="fa fa-bold"></i></button>
                            <button id="prop-italic" class="flex-1 py-1.5 border rounded hover:bg-gray-100 transition-colors"><i class="fa fa-italic"></i></button>
                            <button id="prop-underline" class="flex-1 py-1.5 border rounded hover:bg-gray-100 transition-colors"><i class="fa fa-underline"></i></button>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">字体</label>
                            <select id="prop-fontfamily" class="w-full text-sm border rounded p-2 bg-white">
                                <option value="Arial">Arial</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="SimSun">宋体</option>
                                <option value="Microsoft YaHei">微软雅黑</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 space-y-3">
                        <div class="flex gap-2">
                            <button id="action-bring-front" class="flex-1 py-1.5 text-xs border rounded hover:bg-gray-100">上移一层</button>
                            <button id="action-send-back" class="flex-1 py-1.5 text-xs border rounded hover:bg-gray-100">下移一层</button>
                        </div>
                        <button id="action-delete" class="w-full py-2 bg-red-50 text-red-600 border border-red-200 rounded hover:bg-red-100 transition-colors flex items-center justify-center gap-2">
                            <i class="fa fa-trash"></i> 删除对象
                        </button>
                    </div>
                </div>

                <div class="p-4 mt-auto border-t bg-gray-50">
                    <div class="flex justify-between">
                        <button id="undo-btn" class="text-gray-600 hover:text-primary disabled:opacity-30 flex items-center gap-1 transition-colors"><i class="fa fa-undo"></i> 撤销</button>
                        <button id="redo-btn" class="text-gray-600 hover:text-primary disabled:opacity-30 flex items-center gap-1 transition-colors">重做 <i class="fa fa-repeat"></i></button>
                    </div>
                </div>
            </div>

            <div class="flex-1 bg-gray-200 relative" id="canvas-wrapper-div">
                <canvas id="c"></canvas>
            </div>
        </main>

        <footer class="bg-white border-t py-2 px-4 flex justify-between items-center text-sm text-gray-600 shrink-0 z-20">
            <span id="canvas-info" class="font-mono text-xs">未初始化</span>
            <div class="flex items-center space-x-3">
                <button id="zoom-in" class="hover:bg-gray-100 p-1.5 rounded transition-colors" title="放大"><i class="fa fa-plus"></i></button>
                <span id="zoom-val" class="w-12 text-center font-medium">100%</span>
                <button id="zoom-out" class="hover:bg-gray-100 p-1.5 rounded transition-colors" title="缩小"><i class="fa fa-minus"></i></button>
                <div class="h-4 w-px bg-gray-300 mx-2"></div>
                <button id="zoom-reset" class="hover:bg-gray-100 p-1.5 rounded transition-colors" title="适应屏幕"><i class="fa fa-arrows-alt"></i></button>
            </div>
        </footer>
    </div>

    <div id="crop-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg w-full max-w-6xl h-[85vh] flex flex-col shadow-2xl">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg shrink-0">
                <div>
                    <h3 class="font-bold text-gray-800">调整背景区域</h3>
                    <p class="text-xs text-gray-500">滚动鼠标或使用按钮缩放视图（不影响裁剪范围）</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center bg-white border rounded shadow-sm">
                        <button id="crop-zoom-in" class="px-3 py-1.5 hover:bg-gray-50 border-r" title="放大视图"><i class="fa fa-search-plus"></i></button>
                        <button id="crop-zoom-out" class="px-3 py-1.5 hover:bg-gray-50" title="缩小视图"><i class="fa fa-search-minus"></i></button>
                    </div>
                    <div class="flex items-center bg-white border rounded shadow-sm">
                        <button id="crop-rotate-left" class="px-3 py-1.5 hover:bg-gray-50 border-r" title="向左旋转"><i class="fa fa-rotate-left"></i></button>
                        <button id="crop-rotate-right" class="px-3 py-1.5 hover:bg-gray-50" title="向右旋转"><i class="fa fa-rotate-right"></i></button>
                    </div>
                </div>
            </div>

            <div class="flex-1 w-full relative" id="crop-scroll-container">
                <div id="crop-scale-wrapper">
                    <img id="crop-image" style="display:block; max-width: 100%;">
                </div>
            </div>

            <div class="p-4 border-t flex justify-between items-center bg-gray-50 rounded-b-lg shrink-0">
                <span class="text-sm text-gray-500 flex items-center gap-2">
                    <i class="fa fa-lock"></i> 已锁定比例以匹配纸张尺寸
                </span>
                <div class="space-x-3">
                    <button id="cancel-crop" class="px-5 py-2 border border-gray-300 rounded hover:bg-white bg-gray-50 text-gray-700 transition-colors">取消</button>
                    <button id="confirm-crop" class="px-5 py-2 bg-primary text-white rounded hover:bg-blue-600 shadow-md transition-colors">应用背景</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="js/main.js"></script>
</body>
</html>
